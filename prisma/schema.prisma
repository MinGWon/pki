datasource db {
  provider = "mysql"
  url      = "mysql://pm2:2792@192.168.45.208:3306/2check_pki"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  name         String
  phone        String?
  isAdmin      Boolean       @default(false)  // 관리자 여부 추가
  certificates Certificate[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("users")
}

model Certificate {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  serialNumber String   @unique
  subjectDN    String
  issuerDN     String
  publicKey    String   @db.Text
  notBefore    DateTime
  notAfter     DateTime
  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([serialNumber])
  @@map("certificates")
}

model OAuthClient {
  id           String   @id @default(cuid())
  clientId     String   @unique
  clientSecret String   // null이면 public client
  name         String
  redirectUris Json     // 허용된 redirect URI 목록 (JSON 배열로 저장)
  scopes       Json?    // 허용된 scope 목록 (JSON 배열로 저장)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("oauth_clients")
}

model OAuthAuthorizationCode {
  id                  String   @id @default(uuid())
  code                String   @unique
  clientId            String
  userId              String
  redirectUri         String
  scope               String?
  codeChallenge       String?
  codeChallengeMethod String?
  expiresAt           DateTime
  createdAt           DateTime @default(now())

  @@index([code])
  @@map("oauth_authorization_codes")
}

model OAuthToken {
  id           String   @id @default(uuid())
  accessToken  String   @unique @db.VarChar(500)
  refreshToken String?  @unique @db.VarChar(500)
  clientId     String
  userId       String
  scope        String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([accessToken])
  @@index([refreshToken])
  @@map("oauth_tokens")
}

model RevokedCertificate {
  id           String   @id @default(uuid())
  serialNumber String   @unique
  reason       String?
  revokedAt    DateTime @default(now())

  @@index([serialNumber])
  @@map("revoked_certificates")
}

model Challenge {
  id        String   @id @default(uuid())
  challenge String   @unique
  userId    String?
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([challenge])
  @@map("challenges")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  userId    String?
  clientId  String?
  ipAddress String?
  userAgent String?  @db.Text
  details   Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SmsVerification {
  id        String   @id @default(uuid())
  phone     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([phone])
}
